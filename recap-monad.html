 <!doctype html> <meta charset=utf-8> <title>é‡æ–°ç†è§£ Monad Â· Perfect Freeze!</title> <meta name=viewport content="width=device-width,initial-scale=1"> <meta name=description content="å¯¹äºå¤§å¤šæ•°åˆšåˆšå…¥é—¨å‡½æ•°å¼ç¼–ç¨‹çš„åŒå­¦æ¥è¯´ï¼Œmonadï¼ˆå•å­ã€åˆå«å•ä½“ï¼‰å¯èƒ½æ˜¯è¿™é‡Œé¢çš„ä¸€é“åã€‚ä½ å¯èƒ½å¯¹ mapã€flatMap ä»¥åŠ filter å†ç†Ÿæ‚‰ä¸è¿‡ï¼Œå¯æ˜¯åˆ°äº†é«˜é˜¶çš„æŠ½è±¡å±‚æ¬¡ä¸Šå°±åˆä¼šå˜å¾—ä¸€è„¸æ‡µé€¼ã€‚å…¶å®æ¯ä¸ªäººåœ¨å­¦ä¹ çš„é˜¶æ®µéƒ½ä¼šç»å†è¿™ä¸ªè¿‡ç¨‹ï¼Œä¸è¿‡å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ é‡æ–°ç†è§£ monad ä»¥åŠå…¶ä»–ç›¸å…³çš„æ¦‚å¿µã€‚"> <link rel=alternate href=/feed.xml type=application/atom+xml> <link rel=icon href=/favicon.ico> <link rel=apple-touch-icon href=/apple-touch-icon.png> <link rel=mask-icon href=/favicon.svg color=#ff00b4> <style>body,html{background:#fff}.content a,.navigation{font-weight:700}.content:after{clear:both}*,:after,:before{box-sizing:border-box;margin:0;padding:0}html{font-size:100%;-webkit-text-size-adjust:none;-ms-text-size-adjust:none;text-size-adjust:none;text-rendering:optimizelegibility;image-rendering:optimizequality}body{font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue','Hiragino Sans GB',Arial,sans-serif;font-size:1.6vw;line-height:1.42857143;margin:0 auto;padding:0 22vw;transition:all .2s ease;color:#000;font-feature-settings:'case','ss01','ss02'}@media (max-width:1080px){body{font-size:2.24vw;padding-right:8vw;padding-left:8vw}}@media (max-width:640px){body{font-size:3.84vw;padding-right:4vw;padding-left:4vw}}@media (max-width:400px){body{font-size:5.12vw}}a{transition:color .5s ease,border-color .5s ease,background .5s ease,opacity 1.5s ease;text-decoration:none;color:#000}a:focus,a:hover{transition:color .1s ease,border-color .1s ease,background .1s ease,opacity .1s ease;text-decoration:underline;-webkit-text-decoration-skip:ink;text-decoration-skip:ink}hr,img{border:0}::-moz-selection{background:rgba(108,181,252,.1)}::selection{background:rgba(108,181,252,.1)}::-webkit-input-placeholder{opacity:.2;color:#000}::-moz-placeholder{opacity:.2;color:#000}:-ms-input-placeholder{opacity:.2;color:#000}::placeholder{opacity:.2;color:#000}:focus::-webkit-input-placeholder{color:#6cb5fc}:focus::-moz-placeholder{color:#6cb5fc}:focus:-ms-input-placeholder{color:#6cb5fc}:focus::placeholder{color:#6cb5fc}.navigation{font-size:60%;margin-right:-1.1em;margin-left:-1.1em;padding-top:1.4vmax;padding-bottom:1.4vmax;letter-spacing:.45em;text-transform:uppercase}.navigation li{line-height:2;display:inline-block;list-style:none}.navigation li a{padding:.5em 1.2em}.navigation li a:focus,.navigation li a:hover{text-decoration:none;color:#6cb5fc}.content{margin-bottom:16vmin}.content:after,.content:before{display:table;content:''}.content article>:last-child,.content article>:last-child>:last-child,.content article>:last-child>:last-child>:last-child,.content article>:last-child>:last-child>:last-child>:last-child{margin-bottom:0!important}.content .post-content>:first-child,.content .post-content>:first-child>:first-child{margin-top:0}.content p{line-height:1.71428571;margin-bottom:1.6rem}.content header{display:-ms-flexbox;display:flex;flex-direction:column;min-height:calc(100vh - 5.6vmax - 5ex);margin-right:-22vw;margin-bottom:16vmin;margin-left:-22vw;background:rgba(0,0,0,.02);-ms-flex-direction:column;-ms-flex-pack:center;justify-content:center;padding:10vmin 22vw}@media (max-width:1080px){.content header{min-height:calc(64vh - 1.4vmax * 2 - 3ex);margin-right:-8vw;margin-left:-8vw;padding:16vmin 8vw}}@media (max-width:640px){.content header{margin-right:-4vw;margin-left:-4vw;padding-right:4vw;padding-left:4vw}}.content header h1{font-size:360%;font-weight:700;line-height:1.1;margin-left:-2px;letter-spacing:-.04em;-webkit-hyphens:none;hyphens:none;-webkit-font-smoothing:antialiased;-ms-hyphens:none}.content header small{display:block;margin-top:2vmin}.content h2{font-weight:400;margin:10vmin 0 1rem}.content ol,.content ul{margin-bottom:1.8rem;list-style:none;counter-reset:list}@media (max-width:640px){.content header h1{font-size:280%}.content ol,.content ul{margin-left:1em}}.content ol li,.content ul li{line-height:1.71428571}.content ol li:before,.content ul li:before{font-size:80%;line-height:2.14285714;position:absolute;display:inline-block;width:4em;margin-left:-4em;text-align:right;opacity:.6}.content ul li:before{padding-right:.6em;content:'â€¢'}.content ol li:before{padding-right:.3em;content:counter(list) '.';counter-increment:list}.content img{display:block;width:calc(100% + (1.2vw * 2) + (2px * 2));margin:0 calc(-1.2vw - 2px) 1.8rem}@media (max-width:1080px){.content img{width:calc(100% + (8vw * 2));margin-right:-8vw;margin-left:-8vw}}@media (max-width:640px){.content img{width:calc(100% + (4vw * 2));margin-right:-4vw;margin-left:-4vw}}.content blockquote{font-size:90%;position:relative;margin-bottom:2.8rem;margin-left:calc(-1.2vw - 2px)}.content blockquote>p{margin-bottom:0;padding-bottom:1.6rem;padding-left:1.2vw;opacity:.6;border-left:2px solid}.content blockquote>p:last-of-type{margin-bottom:1.6rem;padding-bottom:0}@media (max-width:640px){.content blockquote{margin-left:0}.content blockquote>p{margin-right:-4vw;margin-left:-4vw;padding-right:4vw;padding-left:calc(4vw - 2px)}}.highlight .c1,.highlight .cm{font-style:italic}.content hr::before{content:'';display:block}.content hr::before{width:3px;height:3px;margin:2em auto;border-radius:50%;background:#000;box-shadow:24px 0 0 0 #000,-24px 0 0 0 #000}.content code,.content pre{font-family:Menlo,Consolas,monospace;color:#54c7fc}.content li code,.content p code{word-break:break-all}.content pre{font-size:80%;line-height:1.71428571;overflow-x:auto;margin-right:-1.2vw;margin-bottom:1.8rem;margin-left:-1.2vw;padding:1.2vw;background:rgba(0,136,255,.04);-webkit-overflow-scrolling:touch}@media (max-width:1080px){.content pre{margin-right:-8vw;margin-left:-8vw;padding-right:8vw;padding-left:8vw}}@media (max-width:640px){.content pre{margin-right:-4vw;margin-left:-4vw;padding-right:4vw;padding-left:4vw}}.footer{font-size:75%;padding:0 0 16vmin;text-transform:lowercase}.footer ul li{display:inline}.footer ul li:after{padding:0 .6vw;content:' / ';opacity:.3}.footer ul li:last-child:after{content:none}@media print{.content .post-content,img{max-width:100%!important}*,:after,:before{color:#000!important;background:0 0!important;box-shadow:none!important;text-shadow:none!important}body{margin:0!important;padding:10mm!important}a,a:visited{text-decoration:none}.content header{min-height:0;padding-bottom:0}.content .post-content a[href]:after{font-weight:400;content:' (' attr(href) ')'}blockquote,img,pre{page-break-inside:avoid}h2,p{orphans:3;widows:3}h2{page-break-after:avoid}.footer,.navigation{display:none}}.highlight .k,.highlight .kc,.highlight .kd,.highlight .kt,.highlight .nf,.highlight .o{font-weight:700}.highlighter-rouge .highlight{background:rgba(32,54,76,.02)}.highlight code{color:#b3b4b5}.highlight .n{color:#599ffc}.highlight .nf{color:#8d67fc}.highlight .nv{color:#c967fc}.highlight .k{color:#df8c76}.highlight .kc{color:#df9876}.highlight .kd{color:#dfa476}.highlight .kt{color:#dfd476}.highlight .mi{color:#59eec6}.highlight .o{color:#59e8fc}.highlight .p{color:#59cffc}.highlight .cm{opacity:.6;color:#b7a29c}.highlight .c1{opacity:.6;color:#8dbea9}.content h2{font-size:108%;opacity:.8}.navigation{text-align:center}</style> <link rel=canonical href=http://blog.cee.moe/recap-monad.html> <meta property=og:type content=article> <meta property=og:site_name content="Perfect Freeze!"> <meta property=og:title content="é‡æ–°ç†è§£ Monad"> <meta property=og:url content=http://blog.cee.moe/recap-monad.html> <meta property=og:description content="å¯¹äºå¤§å¤šæ•°åˆšåˆšå…¥é—¨å‡½æ•°å¼ç¼–ç¨‹çš„åŒå­¦æ¥è¯´ï¼Œmonadï¼ˆå•å­ã€åˆå«å•ä½“ï¼‰å¯èƒ½æ˜¯è¿™é‡Œé¢çš„ä¸€é“åã€‚ä½ å¯èƒ½å¯¹ mapã€flatMap ä»¥åŠ filter å†ç†Ÿæ‚‰ä¸è¿‡ï¼Œå¯æ˜¯åˆ°äº†é«˜é˜¶çš„æŠ½è±¡å±‚æ¬¡ä¸Šå°±åˆä¼šå˜å¾—ä¸€è„¸æ‡µé€¼ã€‚å…¶å®æ¯ä¸ªäººåœ¨å­¦ä¹ çš„é˜¶æ®µéƒ½ä¼šç»å†è¿™ä¸ªè¿‡ç¨‹ï¼Œä¸è¿‡å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ é‡æ–°ç†è§£ monad ä»¥åŠå…¶ä»–ç›¸å…³çš„æ¦‚å¿µã€‚"> <meta name=twitter:card content=summary> <meta name=twitter:title content="é‡æ–°ç†è§£ Monad"> <meta name=twitter:url content=http://blog.cee.moe/recap-monad.html> <meta name=twitter:description content="å¯¹äºå¤§å¤šæ•°åˆšåˆšå…¥é—¨å‡½æ•°å¼ç¼–ç¨‹çš„åŒå­¦æ¥è¯´ï¼Œmonadï¼ˆå•å­ã€åˆå«å•ä½“ï¼‰å¯èƒ½æ˜¯è¿™é‡Œé¢çš„ä¸€é“åã€‚ä½ å¯èƒ½å¯¹ mapã€flatMap ä»¥åŠ filter å†ç†Ÿæ‚‰ä¸è¿‡ï¼Œå¯æ˜¯åˆ°äº†é«˜é˜¶çš„æŠ½è±¡å±‚æ¬¡ä¸Šå°±åˆä¼šå˜å¾—ä¸€è„¸æ‡µé€¼ã€‚å…¶å®æ¯ä¸ªäººåœ¨å­¦ä¹ çš„é˜¶æ®µéƒ½ä¼šç»å†è¿™ä¸ªè¿‡ç¨‹ï¼Œä¸è¿‡å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ é‡æ–°ç†è§£ monad ä»¥åŠå…¶ä»–ç›¸å…³çš„æ¦‚å¿µã€‚"> <meta property=article:published_time content=2016-11-08T00:00:00+08:00> <meta property=article:modified_time content=2016-11-08T00:00:00+08:00> <meta name=twitter:label1 value=Words> <meta name=twitter:data1 value="1194 words"> <meta name=twitter:label2 value="Reading time"> <meta name=twitter:data2 value="5 mins"> <meta name=twitter:site content=@Ceecirno> <meta name=twitter:creator content=@Ceecirno> <nav class=navigation> <ul> <li> <a href=/ > Home </a> </li> <li> <a href=/articles/ > Articles </a> </li> <li> <a href=/works/ > Works </a> </li> <li> <a href=/friends/ > Friends </a> </li> <li> <a href=/about/ > About </a> </li> </ul> </nav> <main class=content role=main> <article> <header> <h1 title="é‡æ–°ç†è§£ Monad" data-title="é‡æ–°ç†è§£ Monad"> é‡æ–°ç†è§£ Monad<span class="dot dot--post"> </span> </h1> <small> By <span rel=author>Cee</span> on <time datetime=2016-11-08T00:00:00+08:00>Nov 8, 2016</time> </small> </header> <div class=post-content> <p>å¯¹äºå¤§å¤šæ•°åˆšåˆšå…¥é—¨å‡½æ•°å¼ç¼–ç¨‹çš„åŒå­¦æ¥è¯´ï¼Œmonadï¼ˆå•å­ã€åˆå«å•ä½“ï¼‰å¯èƒ½æ˜¯è¿™é‡Œé¢çš„ä¸€é“åã€‚ä½ å¯èƒ½å¯¹ <code class=highlighter-rouge>map</code>ã€<code class=highlighter-rouge>flatMap</code> ä»¥åŠ <code class=highlighter-rouge>filter</code> å†ç†Ÿæ‚‰ä¸è¿‡ï¼Œå¯æ˜¯åˆ°äº†é«˜é˜¶çš„æŠ½è±¡å±‚æ¬¡ä¸Šå°±åˆä¼šå˜å¾—ä¸€è„¸æ‡µé€¼ã€‚å…¶å®æ¯ä¸ªäººåœ¨å­¦ä¹ çš„é˜¶æ®µéƒ½ä¼šç»å†è¿™ä¸ªè¿‡ç¨‹ï¼Œä¸è¿‡å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ é‡æ–°ç†è§£ monad ä»¥åŠå…¶ä»–ç›¸å…³çš„æ¦‚å¿µã€‚</p> <h2 id=optional>Optional</h2> <p>Swift ä½œä¸ºä¸€é—¨ç±»å‹å®‰å…¨çš„å¼ºç±»å‹è¯­è¨€ï¼Œå®ƒåœ¨ç¼–è¯‘é˜¶æ®µå°±ä¼šå¯¹ä½ çš„æ•°æ®ç±»å‹è¿›è¡Œæ¯”è¾ƒå¤šçš„æ£€æŸ¥ã€‚å› æ­¤ï¼Œåœ¨ Swift ä¸­æˆ‘ä»¬é‡åˆ°äº†ä¸€ç§æ–°çš„æ•°æ®ç±»å‹ï¼Œå«åš <strong>Optional</strong>ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=kd>public</span> <span class=kd>enum</span> <span class=kt>Optional</span><span class=o>&lt;</span><span class=kt>Wrapped</span><span class=o>&gt;</span> <span class=p>:</span> <span class=kt>ExpressibleByNilLiteral</span> <span class=p>{</span>
    <span class=k>case</span> <span class=k>none</span>
    <span class=k>case</span> <span class=nf>some</span><span class=p>(</span><span class=kt>Wrapped</span><span class=p>)</span>
<span class=p>}</span>
</code></pre> </div> <p>Optional æ˜¯ä¸ªæšä¸¾ç±»å‹ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæœ‰ä¸¤ä¸ªå€¼ï¼š<code class=highlighter-rouge>none</code> ä»¥åŠ <code class=highlighter-rouge>some</code>ã€‚ç®€å•ç‚¹è®²ï¼š</p> <blockquote> <p>å€¼è¦ä¹ˆå­˜åœ¨ï¼ˆpresenceï¼‰ï¼Œè¦ä¹ˆä¸å­˜åœ¨ï¼ˆabsenceï¼‰ã€‚</p> </blockquote> <p>è¿™ä¹Ÿå°±æ„å‘³ç€ Optional å¯èƒ½æ˜¯åŒ…å«äº†ä¸€ä¸ªæŸä¸ªç±»å‹çš„å€¼ï¼ˆ<code class=highlighter-rouge>some</code>ï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼ˆ<code class=highlighter-rouge>none</code>ï¼‰ã€‚åœ¨è¿™é‡Œï¼ŒOptional å°±æ˜¯ä¸ªå®¹å™¨ï¼ˆ<code class=highlighter-rouge>container</code>ï¼‰ã€‚</p> <p><img src=https://ooo.0o0.ooo/2016/11/07/58204a65d8ad7.png alt="Optional Int"></p> <p>å¯¹äºåŸºç¡€ç±»å‹ï¼Œåœ¨å…¶åé¢ç›´æ¥åŠ ä¸Š <code class=highlighter-rouge>?</code> å°±ä»£è¡¨äº†è¿™å°±æ˜¯ä¸ªå¯é€‰å€¼ç±»å‹ï¼ˆOptional valueï¼‰ã€‚é»˜è®¤å€¼å³ä¸º Optional çš„é¢„è®¾å€¼ <code class=highlighter-rouge>nil</code>ï¼ˆåŒºåˆ«äº Objective-Cï¼‰ã€‚</p> <p>åˆ¤æ–­ä¸€ä¸ªå¯é€‰å€¼æ˜¯å¦ä¸ºç©ºï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé‡‡ç”¨ <code class=highlighter-rouge>if let</code> çš„å†™æ³•æ¥è§£åŒ…ï¼ˆwrap an optionalï¼‰ã€‚</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=k>if</span> <span class=k>let</span> <span class=nv>value</span> <span class=o>=</span> <span class=n>value</span> <span class=p>{</span>
    <span class=c1>// if value != nil</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// value = nil</span>
<span class=p>}</span>
</code></pre> </div> <h2 id=map>Map</h2> <p>åŸºç¡€ç±»å‹çš„ <code class=highlighter-rouge>map</code> å‡½æ•°è°ƒç”¨æ˜¯éå¸¸ç®€å•çš„ï¼š</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=k>let</span> <span class=nv>ages</span> <span class=o>=</span> <span class=p>[</span><span class=mi>20</span><span class=p>,</span> <span class=mi>40</span><span class=p>,</span> <span class=mi>50</span><span class=p>]</span>
<span class=k>let</span> <span class=nv>tripledAges</span> <span class=o>=</span> <span class=n>ages</span><span class=o>.</span><span class=n>map</span> <span class=p>{</span> <span class=nv>$0</span> <span class=o>*</span> <span class=mi>3</span> <span class=p>}</span>
<span class=c1>// tripledAges = [40, 80, 100]</span>
</code></pre> </div> <p>å¦‚æœå¯¹äº Optional å‘¢ï¼Ÿ</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=k>let</span> <span class=nv>price</span> <span class=o>=</span> <span class=kt>Optional</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
<span class=k>let</span> <span class=nv>doubledPrice</span> <span class=o>=</span> <span class=n>price</span><span class=o>.</span><span class=n>map</span> <span class=p>{</span> <span class=nv>$0</span> <span class=o>*</span> <span class=mi>2</span> <span class=p>}</span>
<span class=c1>// doubledPrice = Optional(40)</span>

<span class=k>let</span> <span class=nv>nilPrice</span><span class=p>:</span> <span class=kt>Int</span><span class=p>?</span> <span class=o>=</span> <span class=o>.</span><span class=k>none</span> <span class=c1>// equals to `nil`</span>
<span class=k>let</span> <span class=nv>doubledNilPrice</span> <span class=o>=</span> <span class=n>nilPrice</span><span class=o>.</span><span class=n>map</span> <span class=p>{</span> <span class=nv>$0</span> <span class=o>*</span> <span class=mi>2</span> <span class=p>}</span>
<span class=c1>// doubledNilPrice = nil</span>
</code></pre> </div> <p>æˆ‘ä»¬å‘ç°ï¼Œ<code class=highlighter-rouge>map</code> å‡½æ•°ä½œç”¨åœ¨ Optional ä¸Šæ—¶ï¼š</p> <ul> <li>å€¼å­˜åœ¨ï¼ˆ<code class=highlighter-rouge>.some</code>ï¼‰ï¼šå€¼ç±»å‹ <code class=highlighter-rouge>Optional(Int)</code>ï¼Œè¿”å›å€¼ç±»å‹ <code class=highlighter-rouge>Optional(Int)</code>ï¼›</li> <li>å€¼ä¸å­˜åœ¨ï¼ˆ<code class=highlighter-rouge>.none</code>ï¼‰ï¼šè¿”å›å€¼ç­‰åŒè¾“å…¥ï¼ˆ<code class=highlighter-rouge>nil</code>ï¼‰ã€‚</li> </ul> <hr> <p><code class=highlighter-rouge>map</code> å‡½æ•°å®šä¹‰åœ¨ Optional ä¸Šï¼Œæœ€å¤§çš„å¥½å¤„å°±åœ¨äºç©ºå€¼ï¼ˆ<code class=highlighter-rouge>nil</code>ï¼‰çš„å¤„ç†ï¼Œä¸éœ€è¦æˆ‘ä»¬å†å»ä½¿ç”¨ <code class=highlighter-rouge>if let</code> è§£åŒ…ï¼ˆç©ºå€¼å¹¶æ²¡æœ‰ä¹˜æ³•è¿ç®—ï¼‰ï¼š</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=k>let</span> <span class=nv>nilPrice</span><span class=p>:</span> <span class=kt>Int</span><span class=p>?</span> <span class=o>=</span> <span class=o>.</span><span class=k>none</span> <span class=c1>// equals to `nil`</span>
<span class=k>var</span> <span class=nv>doubledNilPrice</span><span class=p>:</span> <span class=kt>Int</span><span class=p>?</span>

<span class=k>if</span> <span class=k>let</span> <span class=nv>nilPrice</span> <span class=o>=</span> <span class=n>nilPrice</span> <span class=p>{</span>
    <span class=n>doubledNilPrice</span> <span class=o>=</span> <span class=n>nilPrice</span> <span class=o>*</span> <span class=mi>2</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>doubledNilPrice</span> <span class=o>=</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre> </div> <p>å› æ­¤ï¼š</p> <blockquote> <p><code class=highlighter-rouge>map</code> åªå¯¹å€¼å­˜åœ¨çš„å¯é€‰å€¼è¿›è¡Œå¤„ç†ã€‚</p> </blockquote> <p><code class=highlighter-rouge>map</code> é€šå¸¸çš„è¡¨ç¤ºæ–¹æ³•ï¼š</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=kd>func</span> <span class=n>map</span><span class=o>&lt;</span><span class=kt>U</span><span class=o>&gt;</span><span class=p>(</span><span class=n>_</span> <span class=nv>f</span><span class=p>:</span> <span class=p>(</span><span class=kt>T</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>U</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Container</span><span class=p>(</span><span class=kt>U</span><span class=p>)</span>
</code></pre> </div> <p>åœ¨è¿™é‡Œï¼Œå®¹å™¨ <code class=highlighter-rouge>Container</code> å°±ç›¸å½“äº <code class=highlighter-rouge>Optional</code>ï¼Œæ³›å‹ <code class=highlighter-rouge>T</code> å’Œ <code class=highlighter-rouge>U</code> å‡ä¸º <code class=highlighter-rouge>Int</code> ç±»å‹ã€‚åœ¨å¤„ç†å®Œ <code class=highlighter-rouge>Int</code> å€¼å <code class=highlighter-rouge>map</code> å‡½æ•°å°±æŠŠ <code class=highlighter-rouge>Int</code> å‹è½¬æ¢æˆäº† <code class=highlighter-rouge>Optional(Int)</code>ï¼Œå¹¶è¿”å›ã€‚</p> <h2 id=async-callback-trouble>Async Callback Trouble</h2> <p>å¤„ç†å¼‚æ­¥çš„ç½‘ç»œè¯·æ±‚æ˜¯ä¸€ä»¶ç—›è‹¦çš„äº‹æƒ…ã€‚ä½ ä¸€å®šç¢°åˆ°è¿‡ï¼š</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=kd>typealias</span> <span class=kt>CompletionBlock</span> <span class=o>=</span> <span class=p>(</span><span class=n>_</span> <span class=nv>data</span><span class=p>:</span> <span class=kt>Data</span><span class=p>?,</span> <span class=n>_</span> <span class=nv>response</span><span class=p>:</span> <span class=kt>URLResponse</span><span class=p>?,</span> <span class=n>_</span> <span class=nv>error</span><span class=p>:</span> <span class=kt>Error</span><span class=p>?)</span> <span class=o>-&gt;</span> <span class=kt>Swift</span><span class=o>.</span><span class=kt>Void</span>

<span class=c1>// Callback</span>
<span class=k>if</span> <span class=n>error</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> 
    <span class=cm>/* Dealing with network errors */</span> 
<span class=p>}</span>
<span class=k>if</span> <span class=k>let</span> <span class=nv>json</span> <span class=o>=</span> <span class=nf>parseToJSON</span><span class=p>(</span><span class=nv>with</span><span class=p>:</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
    <span class=cm>/* Dealing with parsing errors */</span> 
<span class=p>}</span>
<span class=cm>/* Dealing with JSON mapping errors */</span>
<span class=cm>/* Dealing with other errors */</span>
<span class=cm>/* WTF! ğŸ’© Sh*t! */</span>
<span class=cm>/* Finally, with success */</span>
</code></pre> </div> <p>ä¸ºä»€ä¹ˆæˆ‘çš„å¼‚æ­¥å›è°ƒå°±æ²¡æœ‰ä¸€ç§æ–¹å¼èƒ½å¤Ÿå‘Šè¯‰æˆ‘åœ¨å“ªé‡Œå‡ºé”™äº†å‘¢ï¼Ÿæ–¹æ¡ˆå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å…ˆåœ¨å®šä¹‰ä¸€ä¸‹å¼‚æ­¥å¤„ç†çš„ç»“æœï¼ˆ<code class=highlighter-rouge>Result</code>ï¼‰ï¼š</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=kd>enum</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>T</span><span class=o>&gt;</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nf>success</span><span class=p>(</span><span class=kt>T</span><span class=p>)</span>
    <span class=k>case</span> <span class=nf>failure</span><span class=p>(</span><span class=kt>Error</span><span class=p>)</span>
<span class=p>}</span>
</code></pre> </div> <p>æœ‰æ²¡æœ‰å‘ç° <code class=highlighter-rouge>Result</code> ç±»å‹å¾ˆåƒ <code class=highlighter-rouge>Optional</code>ï¼Ÿæ²¡é”™ã€‚å®ƒèƒ½åŒ…å«ä¸€ä¸ªæˆåŠŸçš„è¿”å›å€¼ï¼›ä¹Ÿèƒ½åœ¨æ²¡æœ‰è¿”å›å€¼æ—¶æä¾›ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚</p> <hr> <p>æˆ‘ä»¬ä¹ŸåŒæ—¶å¸Œæœ› <code class=highlighter-rouge>map</code> èƒ½å¸®æˆ‘ä»¬å¤„ç† <code class=highlighter-rouge>Result</code>ï¼šå¦‚æœæœ‰ç»“æœï¼Œå°±ä» <code class=highlighter-rouge>JSON</code> è½¬æ¢åˆ° <code class=highlighter-rouge>String</code>ã€å†è½¬æ¢åˆ°å…¶ä»–ç±»å‹ï¼›å¦åˆ™è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</p> <p>è¿™æ ·çš„ <code class=highlighter-rouge>map</code> å‡½æ•°æ€ä¹ˆå†™å‘¢ï¼Ÿä¸å¦¨å…ˆæ¥çœ‹ä¸€ä¸‹ï¼š</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=kd>func</span> <span class=n>map</span><span class=o>&lt;</span><span class=kt>U</span><span class=o>&gt;</span><span class=p>(</span><span class=n>_</span> <span class=nv>f</span><span class=p>:</span> <span class=p>(</span><span class=kt>T</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>U</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>U</span><span class=o>&gt;</span> <span class=p>{</span>
    <span class=k>switch</span> <span class=k>self</span> <span class=p>{</span>
    <span class=k>case</span> <span class=kd>let</span> <span class=o>.</span><span class=nf>success</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
        <span class=k>return</span> <span class=o>.</span><span class=nf>success</span><span class=p>(</span><span class=nf>f</span><span class=p>(</span><span class=n>value</span><span class=p>))</span>
    <span class=k>case</span> <span class=kd>let</span> <span class=o>.</span><span class=nf>failure</span><span class=p>(</span><span class=n>error</span><span class=p>):</span>
        <span class=k>return</span> <span class=o>.</span><span class=nf>failure</span><span class=p>(</span><span class=n>error</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre> </div> <p>ä¸¾ä¸ªæœ€åŸºæœ¬çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¸Œæœ›å°†è¿”å›çš„ <code class=highlighter-rouge>JSON</code> è½¬æ¢æˆ <code class=highlighter-rouge>String</code>ï¼Œé‚£åœ¨è¿™é‡Œï¼Œ<code class=highlighter-rouge>map</code> æ‰€æ¥å—çš„é«˜é˜¶å˜æ¢ <code class=highlighter-rouge>f</code> å°±æ˜¯ä¸€ä¸ª <code class=highlighter-rouge>JSON -&gt; String</code> çš„å‡½æ•°ã€‚è°ƒç”¨æ—¶ï¼Œ<code class=highlighter-rouge>Result&lt;JSON&gt;</code> å°±ä¼šé€šè¿‡ <code class=highlighter-rouge>map</code> æœ€ç»ˆè½¬æ¢æˆ <code class=highlighter-rouge>Result&lt;String&gt;</code> ç±»å‹ã€‚</p> <p><img src=https://ooo.0o0.ooo/2016/11/07/5820b02a37f15.png alt=map></p> <p>çœ‹ä¸Šå»å¾ˆä¸é”™ï¼</p> <h2 id=functor>Functor</h2> <p>åœ¨äº†è§£ monad ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹å®ƒçš„å­ªç”Ÿå…„å¼Ÿï¼šfunctorï¼ˆå‡½å­ï¼‰ã€‚</p> <p>ä»ä¸Šé¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨ <code class=highlighter-rouge>map</code> å‡½æ•°åï¼Œæˆ‘ä»¬è¿˜ä¼šæŠŠ <code class=highlighter-rouge>String</code> ç±»å‹çš„ç»“æœå°è£…æˆäº†ä¸€ä¸ªå¯é€‰å€¼ <code class=highlighter-rouge>Result&lt;String&gt;</code>ã€‚</p> <p>åƒè¿™æ ·èƒ½å¤Ÿä»å®¹å™¨ï¼ˆContainerï¼Œè¿™é‡Œå³ <code class=highlighter-rouge>Result</code>ï¼‰ä¸­å–å‡ºå…ƒç´ ï¼Œå¹¶é€šè¿‡æŸä¸ªå‡½æ•°å°†å…¶è½¬æ¢æˆå¯ä»¥å†æ¬¡è¢«å®¹å™¨åŒ…è£…çš„ç»“æœçš„ç±»å‹å°±ç§°ä¹‹ä¸º functorã€‚</p> <p>è¿˜æœ‰äº›ä¸æ‡‚ï¼Ÿæ²¡äº‹ï¼Œæš‚æ—¶å°±å…ˆè®°ä½æœ‰ functor è¿™ä¹ˆä¸ªç©æ„å„¿ã€‚</p> <h2 id=flatmap>FlatMap</h2> <p>é‡æ–°å›åˆ°ä¹‹å‰ <code class=highlighter-rouge>JSON -&gt; String</code> çš„ä¾‹å­ä¸Šæ¥ã€‚å‡è®¾æˆ‘ä»¬å·²ç»å°†æŸä¸ª json è½¬æ¢æˆäº†å­—ç¬¦ä¸²ï¼Œç°åœ¨éœ€è¦å°†å­—ç¬¦ä¸²é‡æ–°æ ¼å¼åŒ–ï¼Œé‚£æˆ‘ä»¬åº”è¯¥éœ€è¦å†è°ƒç”¨ä¸€æ¬¡ <code class=highlighter-rouge>map</code>ï¼š</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=kd>func</span> <span class=nf>map</span><span class=p>(</span><span class=n>_</span> <span class=nv>f</span><span class=p>:</span> <span class=kt>JSON</span> <span class=o>-&gt;</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>String</span><span class=o>&gt;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>Result</span><span class=o>&lt;</span><span class=kt>String</span><span class=o>&gt;&gt;</span>
</code></pre> </div> <p>ä¸è¿‡æˆ‘ä»¬å¤šä¹ˆå¸Œæœ›è¿”å›çš„ç»“æœæ˜¯ä¸ª <code class=highlighter-rouge>Result&lt;String&gt;</code> çš„ç±»å‹ã€‚ä¸å¦‚å†™ä¸€ä¸ªå‡½æ•°æ¥è§£åŒ…å¸¦æœ‰ä¸¤å±‚çš„ <code class=highlighter-rouge>Result&lt;T&gt;</code>ã€‚</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=kd>func</span> <span class=n>flatten</span><span class=o>&lt;</span><span class=kt>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>_</span> <span class=nv>f</span><span class=p>:</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>Result</span><span class=o>&lt;</span><span class=kt>T</span><span class=o>&gt;&gt;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>T</span><span class=o>&gt;</span> <span class=p>{</span>
    <span class=k>switch</span> <span class=n>f</span> <span class=p>{</span>
    <span class=k>case</span> <span class=kd>let</span> <span class=o>.</span><span class=nf>success</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>value</span>
    <span class=k>case</span> <span class=kd>let</span> <span class=o>.</span><span class=nf>failure</span><span class=p>(</span><span class=n>error</span><span class=p>):</span>
        <span class=k>return</span> <span class=o>.</span><span class=nf>failure</span><span class=p>(</span><span class=n>error</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre> </div> <p>è¿˜æœ‰ä¸€ç‚¹ï¼Œåœ¨å†™ <code class=highlighter-rouge>flatten</code> å‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹ŸåŒæ—¶è€ƒè™‘äº†åœ¨ <code class=highlighter-rouge>map</code> å‡½æ•°ä¸­å‡ºç°è½¬æ¢å¤±è´¥çš„é—®é¢˜ã€‚è½¬æ¢æ­£ç¡®çš„æ—¶å€™çš„ç¡®æˆ‘ä»¬çš„ <code class=highlighter-rouge>map</code> çš„è¾“å‡ºæ˜¯ä¸ª <code class=highlighter-rouge>String</code> ç±»å‹çš„å€¼ï¼Œéšä¹‹è¾“å‡º <code class=highlighter-rouge>Result&lt;String&gt;</code> è¿›å…¥ä¸‹ä¸€å±‚çš„ <code class=highlighter-rouge>map</code>ï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™åº”å½“æ˜¯è¢«è½¬æ¢æˆ <code class=highlighter-rouge>.failure</code> çš„ç»“æœã€‚</p> <p>å°† <code class=highlighter-rouge>map</code> å’Œ <code class=highlighter-rouge>flatten</code> ç»“åˆä¸€ä¸‹ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†æ‰€è°“çš„ <code class=highlighter-rouge>flatMap</code>ï¼ˆåˆç§°ä½œ <code class=highlighter-rouge>bind</code>ï¼‰ï¼š</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=kd>func</span> <span class=n>flatMap</span><span class=o>&lt;</span><span class=kt>U</span><span class=o>&gt;</span><span class=p>(</span><span class=n>_</span> <span class=nv>f</span><span class=p>:</span> <span class=p>(</span><span class=kt>T</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>U</span><span class=o>&gt;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>U</span><span class=o>&gt;</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nf>flatten</span><span class=p>(</span><span class=nf>map</span><span class=p>(</span><span class=n>f</span><span class=p>))</span>
<span class=p>}</span>
</code></pre> </div> <p><img src=https://ooo.0o0.ooo/2016/11/07/5820b02a72cf8.png alt=flatMap></p> <p>é€šè¿‡ <code class=highlighter-rouge>flatMap</code> æˆ‘ä»¬å¯ä»¥éå¸¸è½»æ¾åœ°å¤„ç†ä¸­é€”å‡ºç°çš„é”™è¯¯å¼‚å¸¸ï¼Œå¹¶å¯¹ç»™å®šç±»å‹è¿›è¡Œå¤šæ¬¡è¿ç»­çš„ç±»å‹è½¬æ¢ã€‚</p> <h2 id=monad>Monad</h2> <p>æœ€åå†æ¥è¯´ä»€ä¹ˆæ˜¯ monadã€‚Chris Edihof æ›¾åœ¨ä»–çš„æ–‡ç« ä¸­æŒ‡å‡ºï¼š</p> <blockquote> <p>å¦‚æœå¯ä»¥ä¸ºæŸä¸ªç±»å‹å®šä¹‰å®ƒçš„ <code class=highlighter-rouge>flatMap</code> æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å‹é€šå¸¸å°±æ˜¯ä¸ª <code class=highlighter-rouge>monad</code>ã€‚ï¼ˆIf you can define <code class=highlighter-rouge>flatMap</code> for a type, the type is often called a <code class=highlighter-rouge>monad</code>.ï¼‰</p> </blockquote> <p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡ <code class=highlighter-rouge>map</code> å’Œ <code class=highlighter-rouge>flatten</code> å®ç°äº† <code class=highlighter-rouge>Result</code> ç±»å‹çš„ <code class=highlighter-rouge>flatMap</code>ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯´ <code class=highlighter-rouge>Result</code> è¿™ä¸ªç±»å‹å°±æ˜¯ä¸€ä¸ª monadã€‚</p> <h2 id=deal-with-monad>Deal with Monad</h2> <p>åˆ°ç°åœ¨ä½ å°±å¯ä»¥éå¸¸è½»æ¾åœ°å¤„ç†ä½ çš„å¼‚æ­¥è¯·æ±‚äº†ã€‚</p> <div class="language-swift highlighter-rouge"><pre class=highlight><code><span class=kd>func</span> <span class=nf>toString</span><span class=p>(</span><span class=n>_</span> <span class=nv>data</span><span class=p>:</span> <span class=kt>Data</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>String</span><span class=o>&gt;</span>
<span class=kd>func</span> <span class=nf>toInt</span><span class=p>(</span><span class=n>_</span> <span class=nv>str</span><span class=p>:</span> <span class=kt>String</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>Int</span><span class=o>&gt;</span> 
<span class=kd>func</span> <span class=nf>toImage</span><span class=p>(</span><span class=n>_</span> <span class=nv>num</span><span class=p>:</span> <span class=kt>Int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>UIImage</span><span class=o>&gt;</span>
<span class=kd>func</span> <span class=nf>applyBlur</span><span class=p>(</span><span class=n>_</span> <span class=nv>image</span><span class=p>:</span> <span class=kt>UIImage</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Result</span><span class=o>&lt;</span><span class=kt>UIImage</span><span class=o>&gt;</span>

<span class=c1>// WOW!</span>
<span class=nf>toString</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
    <span class=o>.</span><span class=nf>flatMap</span><span class=p>(</span><span class=n>toInt</span><span class=p>)</span>
    <span class=o>.</span><span class=nf>flatMap</span><span class=p>(</span><span class=n>toImage</span><span class=p>)</span>
    <span class=o>.</span><span class=nf>flatMap</span><span class=p>(</span><span class=n>applyBlur</span><span class=p>)</span>
</code></pre> </div> <h2 id=summary>Summary</h2> <ul> <li>é‡æ–°å›é¡¾ä¸€ä¸‹ <code class=highlighter-rouge>map</code> å’Œ <code class=highlighter-rouge>flatMap</code> åœ¨ <code class=highlighter-rouge>Result&lt;T&gt;</code> ä¸Šçš„å·¥ä½œæ–¹å¼ï¼š</li> </ul> <p><img src=https://ooo.0o0.ooo/2016/11/07/5820b3639d4f0.jpg alt=map></p> <p><img src=https://ooo.0o0.ooo/2016/11/07/5820b3638931b.jpg alt=flatMap></p> <ul> <li>Functorã€monad å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§è¿ç®—çš„æŠ½è±¡ã€‚å®ƒä»¬çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†æ›´å¥½çš„è§£å†³ç±»å‹çš„å°è£…å’Œè½¬æ¢ã€‚</li> </ul> <h2 id=further-reading>Further Reading</h2> <ul> <li>ReactiveCocoa</li> <li>Promise &amp; Future</li> <li>Swift ä¸­çš„ <code class=highlighter-rouge>throw</code> åŠ <code class=highlighter-rouge>rethrow</code></li> </ul> <h2 id=references>References</h2> <ol> <li><a href=http://www.javiersoto.me/post/106875422394>Functor and Monad in Swift - Javier Soto</a></li> <li><a href=http://www.infoq.com/cn/articles/swift-brain-gym-monad>Swift çƒ§è„‘ä½“æ“ï¼ˆäº”ï¼‰- Monad - å”å·§</a></li> <li><a href=https://realm.io/news/swift-tasks-nevyn-bengtsson>Monads Everywhere: Porting C#â€™s Tasks to Swift - Nevyn Bengtsson</a></li> <li><a href=http://chris.eidhof.nl/post/monads-in-swift/ >Monads in Swift - Chris Edihof</a></li> <li><a href=http://www.slideshare.net/UsrNameu1/swift-46430613>ç¶šãƒ»ã‚²ãƒ³ãƒã®Swift</a></li> </ol> </div> </article> </main> <footer class=footer> <ul> <li><a href=/ >Perfect Freeze!</a></li> <li><a href=http://sparanoid.com/lab/amsf/ title="Almace Scaffolding">AMSF</a></li> <li><a href=http://sparanoid.com/lab/amsf/theme-curtana.html title=Curtana>Curtana</a></li> <li><a href=/feed.xml title="Feed - Atom (The Atom Syndication Format)">Atom</a></li> </ul> </footer> <script></script> <script></script> <script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-48656879-8","auto"),ga("send","pageview")</script> 